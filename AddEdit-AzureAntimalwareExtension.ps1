## Script to Bulk Add/Edit Exclusions, Paths and Processes for Microsoft Antimalware

## Login to the Azure Subscription and select the SubID
Login-AzureRmAccount
Select-AzureRmSubscription -SubscriptionId "xx"

## Variable to identify where you're importing the CSV from and the name of the table - in my case, ServerNames 
$ServersList = import-csv 'drive:\file.csv' | select ServerNames


foreach($Server in $ServersList) {
$res = Find-AzureRmResource -ResourceType "Microsoft.Compute/virtualMachines" -ResourceNameContains $Server.ServerNames

$vm = Get-AzureRmVM -ResourceGroupName $res.ResourceGroupName -Name $res.Name

$jsoncfg = '{ 
		"AntimalwareEnabled": true, 
"RealtimeProtectionEnabled": true, 
"Exclusions": {"Extensions": ".FWD;.GSC;.GSE;.MYD;.MYI;.SMD;.VAC;.BAK;.CHK;.FRM;.LDF;.LOG;.MBX;.MDF;.NDF;.TRN;.UND;.UNF;.UNH;.UNI;.UNQ;.UNS;.VHD;.VMDX;.WCI;.EDB;.SDS", 
"Paths": "C:\\rs-pkgs;C:\\System Volume Information\\DFSR;C:\\Sysvol;C:\\ProgramData\\Microsoft\\SharePoint;C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions;C:\\Program Files\\Operations Manager;C:\\Program Files\\Microsoft Monitoring Agent;C:\\Program Files\\Microsoft Office Servers;C:\\Program Files\\Microsoft System Center 2012 R2\\Server;C:\\Program Files\\System Center Operations Manager;C:\\Program Files\\System Center Operations Manager 2007;C:\\Windows\\Microsoft.NET\\Framework64\\v2.0.50727\\Temporary ASP.NET Files;C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\Temporary ASP.NET Files\\ \\Windows\\NTDS;C:\\Windows\\System32\\LogFiles;C:\\Windows\\Sysvol;C:\\Program Files\\Double-Take Software;C:\\Program Files\\DoubleTake;C:\\Program Files\\Exchsrvr;C:\\Program Files\\Ipswitch;C:\\Program Files\\LogMeIn;C:\\Windows\\SoftwareDistribution\\Datastore", 
"Processes": "HealthService.exe;ManagementService.exe;Microsoft.Mom.Sdk.Service.exe;Microsoft.Mom.ConfigServiceHost.exe;MonitoringHost.exe;pagefile.sys;inetinfo.exe;w3wp.exe;sqlservr.exe;SQLAGENT.exe;ReportingServicesService.exe;msmdsrv.exe;MsDtsSrvr.exe;conhost.exe;" }
					}'
$allVersions= (Get-AzureRmVMExtensionImage -Location $vm.Location -PublisherName "Microsoft.Azure.Security" -Type "IaaSAntimalware").Version
$typeHandlerVer = $allVersions[($allVersions.count)–1]
$typeHandlerVerMjandMn = $typeHandlerVer.split(".")
$typeHandlerVerMjandMn = $typeHandlerVerMjandMn[0] + "." + $typeHandlerVerMjandMn[1]

Write-Host $vm.Name  "Parsing new configuration.. This may take up to 10 minutes per VM"

Set-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name "IaaSAntimalware" -Publisher "Microsoft.Azure.Security" -ExtensionType "IaaSAntimalware" -TypeHandlerVersion $typeHandlerVerMjandMn -SettingString $jsoncfg -Location $vm.Location

}
