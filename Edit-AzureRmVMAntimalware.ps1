#  Script to Add Microsoft Antimalware into ARM VMs OR edit existing settings
#  Based off https://blogs.msdn.microsoft.com/azuresecurity/2016/02/24/update-on-microsoft-antimalware-and-azure-resource-manager-arm-vms/ - further changes coming

# Enter your Subscription ID

$subscriptionId = "Enter SubID"

# Specify the VM location, it's Resource Group and it's VMName

$vmLocation = "region"
$resourceGroupName = "Resource Group"
$vmName = "vmName"

# The SettingString has to be done the JSON way

$settingString = ‘{
"AntimalwareEnabled": true,
"RealtimeProtectionEnabled": true,
"ScheduledScanSettings": {
"isEnabled": true,
"day": 1,
"time": 180,
"scanType": "Full"
},
"Exclusions": {
"Extensions": ".mdf;.ldf;.ndf;.bak;.trn;",
"Paths": "D:\\Logs;E:\\Databases;C:\\Program Files\\Microsoft SQL Server\\MSSQL\\FTDATA",
"Processes": "SQLServr.exe;ReportingServicesService.exe;MSMDSrv.exe"
}
}’;

# Login to your Azure Account and select the Subscription to use
Login-AzureRmAccount
Select-AzureRmSubscription -SubscriptionId $subscriptionId

# Get the most recent version for the Extension

$allVersions= (Get-AzureRmVMExtensionImage -Location $vmLocation -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]

# set the extension using prepared values

Set-AzureRmVMExtension -ResourceGroupName $resourceGroupName -Location $vmLocation -VMName $vmName -Name "IaaSAntimalware" -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” -TypeHandlerVersion $versionString -SettingString $settingString
